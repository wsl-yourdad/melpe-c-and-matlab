# MELPe 1200bps 语音编解码器

MELPe (Mixed Excitation Linear Prediction enhanced) 是美国军用标准语音编码算法 (MIL-STD-3005)，也是 NATO STANAG-4591 标准。

## 特性

- **码率**: 1200 bps（每秒仅 150 字节）
- **帧大小**: 540 样本 (67.5ms @ 8kHz)
- **压缩输出**: 81 bits (11 字节) / 帧
- **压缩比**: 约 97:1
- **采样率**: 8000 Hz, 16-bit, 单声道

---

## 快速测试（不使用 VAD）

### 前提条件

- WSL (Windows Subsystem for Linux) 或 Linux 环境
- GCC 编译器
- FFmpeg（用于音频格式转换）

### 1. 编译

```bash
cd /mnt/d/Code/melpe/melpe
make clean
make
```

成功后会生成：
- `encoder` - 编码器可执行文件
- `decoder` - 解码器可执行文件
- `libmelpe.a` - 静态链接库

### 2. 准备测试音频

音频格式要求：**8kHz, 16-bit, 单声道, RAW PCM**

```bash
# 将任意音频转换为所需格式
ffmpeg -i your_audio.wav -ar 8000 -ac 1 -f s16le input.raw
```

### 3. 编码

```bash
./encoder input.raw compressed.bin
```

输入: 526 KB → 输出: ~5.4 KB

### 4. 解码

```bash
./decoder compressed.bin output.raw
```

### 5. 转换为可播放格式

```bash
ffmpeg -f s16le -ar 8000 -ac 1 -i output.raw output.wav
```

### 6. 验证压缩效果

```bash
ls -lh input.raw compressed.bin output.raw
```

期望结果：
| 文件 | 大小 |
|------|------|
| input.raw | ~526 KB |
| compressed.bin | ~5.4 KB |
| output.raw | ~527 KB |

---

## API 使用

只需要 3 个函数：

```c
#include "melpe.h"

// 初始化编解码器
melpe_i();

// 编码: 540 个 16-bit 样本 → 11 字节
unsigned char buf[11];
short samples[540];
melpe_a(buf, samples);

// 解码: 11 字节 → 540 个 16-bit 样本
melpe_s(samples, buf);
```

---

## 文件说明

### 核心文件

| 文件 | 说明 |
|------|------|
| `melpe.h` | **公共 API 头文件** |
| `melpe.c` | **核心 API 实现**，封装 melpe_i/melpe_a/melpe_s |
| `melp_ana.c` | **编码核心**：语音分析，提取 LPC、基音、增益等参数 |
| `melp_syn.c` | **解码核心**：语音合成，从参数重建语音 |
| `melp_sub.c` | 编解码公共子程序 |
| `melp_chn.c` | 信道编码，参数打包/解包 |

### 测试程序

| 文件 | 说明 |
|------|------|
| `encoder.c` | 简单编码器主程序 |
| `decoder.c` | 简单解码器主程序 |

### 信号处理库

| 文件 | 说明 |
|------|------|
| `dsp_sub.c/h` | DSP 子程序（滤波、窗函数等） |
| `fft_lib.c/h` | FFT 快速傅里叶变换 |
| `lpc_lib.c/h` | LPC 线性预测分析 |
| `pit_lib.c/h` | 基音检测库 |
| `pitch.c/h` | 基音分析 |
| `harm.c/h` | 谐波处理 |
| `fs_lib.c/h` | 傅里叶级数库 |
| `vq_lib.c/h` | 矢量量化库 |

### 数学运算库

| 文件 | 说明 |
|------|------|
| `math_lib.c/h` | 数学函数库 |
| `mat_lib.c/h` | 矩阵运算库 |
| `mathhalf.c/h` | 16-bit 定点运算 |
| `mathdp31.c/h` | 32-bit 定点运算 |

### 码本和量化

| 文件 | 说明 |
|------|------|
| `msvq_cb.c/h` | 多级矢量量化码本 |
| `fsvq_cb.c/h` | 傅里叶级数矢量量化码本 |
| `qnt12.c/h` | 1200bps 量化器 |
| `qnt12_cb.c/h` | 1200bps 量化码本 |
| `coeff.c/h` | 滤波器系数 |

### 其他

| 文件 | 说明 |
|------|------|
| `npp.c/h` | 噪声预处理器 |
| `postfilt.c/h` | 后置滤波器 |
| `classify.c` | 语音分类（清音/浊音/静音） |
| `fec_code.c/h` | 前向纠错编码 |
| `global.c/h` | 全局变量 |
| `sc1200.h` | SC1200 编码器常量定义 |
| `constant.h` | 常量定义 |
| `macro.h` | 宏定义 |
| `cprv.h` | 私有结构定义 |

---

## 数据流程

```
编码 (melpe_a):
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 540 samples │───►│ npp()       │───►│ analysis()  │───► 11 bytes
│ (67.5 ms)   │    │ 噪声预处理  │    │ 参数提取    │
└─────────────┘    └─────────────┘    └─────────────┘

解码 (melpe_s):
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  11 bytes   │───►│ 参数解码    │───►│ synthesis() │───► 540 samples
│  (81 bits)  │    │             │    │ 语音合成    │
└─────────────┘    └─────────────┘    └─────────────┘
```

---

## 移植到 DSP/MCU

核心算法文件可直接移植，要求：
- 至少 50 MIPS 运算能力
- 需要硬件浮点或足够的定点运算能力
- 约 20-30 KB RAM

移植步骤：
1. 复制所有 `.c` 和 `.h` 文件到目标工程
2. 实现音频输入输出接口
3. 在主循环中调用 `melpe_a()` 和 `melpe_s()`

---

## 参考

- MIL-STD-3005 (MELPe 标准)
- NATO STANAG-4591
- 原始项目: [PairPhone](http://torfone.org/pairphone)


┌─────────────────────────────────────────────────────────────────┐
│                        编码过程 (melpe_a)                        │
├─────────────────────────────────────────────────────────────────┤
│  输入: 540 个 16-bit 采样 (67.5ms)                               │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │ npp() x 3   │ ← 噪声预处理 (每180样本一次)                    │
│  └─────────────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐     提取参数:                                   │
│  │ analysis()  │ ←  - LPC 系数 (线性预测)                        │
│  │ melp_ana.c  │     - 基音周期 (pitch)                          │
│  └─────────────┘     - 增益 (gain)                               │
│         │            - 清浊音标志                                │
│         ▼                                                       │
│  输出: 11 字节 (81 bits) 压缩码流                                │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        解码过程 (melpe_s)                        │
├─────────────────────────────────────────────────────────────────┤
│  输入: 11 字节 (81 bits) 压缩码流                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐     还原参数:                                   │
│  │ synthesis() │ ←  - 解码 LPC 系数                              │
│  │ melp_syn.c  │     - 重建激励信号                              │
│  └─────────────┘     - LPC 合成滤波                              │
│         │                                                       │
│         ▼                                                       │
│  输出: 540 个 16-bit 采样                                        │
└─────────────────────────────────────────────────────────────────┘